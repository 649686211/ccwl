/*
 * TouchScroll v1.0.1
 * By qiqiboy, http://www.qiqiboy.com, http://weibo.com/qiqiboy, 2012/04/06
 */

function TouchScroll(a){this.cfg=this.parseArgs(a);this.container=typeof this.cfg.id=="string"?this.$(this.cfg.id):this.cfg.id;try{if(!this.container){throw new Error("Can't find element")}for(var c=0,b=this.instances.length;c<b;c++){if(this.instances[c]==this.container){throw new Error("An instance has being running!")}}this.instances.push(this.container);this.setup()}catch(d){this.error=d.message}}TouchScroll.prototype={_default:{id:"slider",width:4,minLength:20,opacity:0.8,onscroll:new Function(),ondrag:new Function(),color:"black",mouseAlign:1},instances:[],$:function(a){return document.getElementById(a)},$C:function(b,a){var d=document.createElement(b)||null;a=Object.prototype.toString.call(a)=="[object Object]"?a:{};if(d){for(var c in a){if(c=="style"){d.style.cssText+=a[c]}else{d.setAttribute(c,a[c])}}}return d},css:(function(){var b=function(f){switch(f){case"float":return("cssFloat" in document.body.style)?"cssFloat":"styleFloat";break;case"opacity":return("opacity" in document.body.style)?"opacity":{get:function(h,g){var i=g.filter;return i&&i.indexOf("opacity")>=0&&parseFloat(i.match(/opacity=([^)]*)/i)[1])/100+""||"1"},set:function(g,h){g.style.filter="alpha(opacity="+h*100+")";g.style.zoom=1}};break;default:var d=f.split("-");for(var e=1;e<d.length;e++){d[e]=d[e].substring(0,1).toUpperCase()+d[e].substring(1)}f=d.join("");return f;break}},a=function(e,g){g=b(g);var f=e.style[g];if(!f){var d=document.defaultView&&document.defaultView.getComputedStyle&&getComputedStyle(e,null)||e.currentStyle||e.style;if(typeof g=="string"){f=d[g]}else{f=g.get(e,d)}}return f=="auto"?"":f},c=function(g,f){var d;for(var e in f){d=b(e);if(typeof d=="string"){g.style[d]=f[e]}else{d.set(g,f[e])}}};return function(e,d){return typeof d=="string"?a(e,d):c(e,d)}})(),parseArgs:function(b){var a={},d=Object.prototype.toString;if(b&&d.call(b)=="[object Object]"){for(var c in this._default){a[c]=typeof b[c]==="undefined"?this._default[c]:d.call(this._default[c])=="[object Number]"?parseInt(parseFloat(b[c])*100)/100:b[c]}}else{a=this._default}return a},addListener:function(b,d,c,a){if(b.addEventListener){b.addEventListener(d,c,a);return true}else{if(b.attachEvent){b.attachEvent("on"+d,c);return true}}return false},getPoint:function(d){d=d||window.event;var b=y=0,c=this.supportsTouches&&d.touches.length?d.touches[0]:d,e=document.documentElement,a=document.body;if(window.pageXOffset){b=window.pageXOffset;y=window.pageYOffset}else{b=(e&&e.scrollLeft||a&&a.scrollLeft||0)-(e&&e.clientLeft||a&&a.clientLeft||0);y=(e&&e.scrollTop||a&&a.scrollTop||0)-(e&&e.clientTop||a&&a.clientTop||0)}b+=c.clientX;y+=c.clientY;return{x:b,y:y}},preventDefault:function(a){if(window.event){window.event.returnValue=false}else{a.preventDefault()}},contains:function(a,b){return a.contains?a!=b&&a.contains(b):!!(a.compareDocumentPosition(b)&16)},bind:function(a,b){return function(){return a.apply(b,arguments)}},deleteAll:function(){for(var a=0;a<arguments.length;a++){delete this[arguments[a]]}},fixedMouse:function(d,c){var b,a=d.type.toLowerCase();if(a=="mouseover"){b=d.relatedTarget||d.fromElement}else{if(a="mouseout"){b=d.relatedTarget||d.toElement}else{return true}}return !b||b.prefix!="xul"&&!this.contains(c,b)&&b!==c},setup:function(){var a=document.documentElement||document.getElementsByTagName("html")[0];this.supportsTouches=("createTouch" in document)||("ontouchstart" in window);this.supportsTransition=("WebkitTransition" in a.style)||("MsTransition" in a.style)||("MozTransition" in a.style)||("OTransition" in a.style)||("transition" in a.style);this.startEvent=this.supportsTouches?"touchstart":"mousedown";this.moveEvent=this.supportsTouches?"touchmove":"mousemove";this.endEvent=this.supportsTouches?"touchend":"mouseup";this.overEvent=this.supportsTouches?"touchstart":"mouseover";this.outEvent=this.supportsTouches?"touchend":"mouseout";this.property=[["left","right","width","clientWidth","scrollWidth","horizontalBar","horizontalScrollBar"],["top","bottom","height","clientHeight","scrollHeight","verticalBar","verticalScrollBar"]];this.timer=[null,null];this.resize();this.addListener(window,"resize",this.bind(function(){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(this.bind(this.resize,this),100)},this),false);this.addListener(document,this.moveEvent,this.bind(this.move,this),false);this.addListener(document,this.endEvent,this.bind(this.end,this),false);this.addListener(this.container,"touchcancel",this.bind(this.end,this),false);this.addListener(this.container,this.overEvent,this.bind(this.toggleShow,this),false);this.addListener(this.container,this.outEvent,this.bind(this.toggleShow,this),false);this.addListener(this.container,"mousewheel",this.bind(this.mouseScroll,this),false);this.addListener(this.container,"DOMMouseScroll",this.bind(this.mouseScroll,this),false)},clear:function(){if(this.element){this.css(this.container,{visibility:"hidden"});while(this.element.childNodes.length){this.container.appendChild(this.element.firstChild)}this.container.removeChild(this.wrapper);this.container.scrollLeft=-this.ratio0*(this.container.scrollWidth-this.container.clientWidth);this.container.scrollTop=-this.ratio1*(this.container.scrollHeight-this.container.clientHeight);this.wrapper=this.element=this.horizontalBar=this.verticalBar=this.horizontalScrollBar=this.verticalScrollBar=null;this.css(this.container,{visibility:"visible"})}},resize:function(){this.clear();var b=parseInt(this.css(this.container,"padding-left"))+parseInt(this.css(this.container,"padding-right")),a=parseInt(this.css(this.container,"padding-top"))+parseInt(this.css(this.container,"padding-bottom")),d=this.container.offsetWidth-(parseInt(this.css(this.container,"border-left-width"))||0)-(parseInt(this.css(this.container,"border-right-width"))||0)-this.container.clientWidth,f=this.container.offsetHeight-(parseInt(this.css(this.container,"border-top-width"))||0)-(parseInt(this.css(this.container,"border-bottom-width"))||0)-this.container.clientHeight;this.clientWidth=this.container.clientWidth-b+d;this.clientHeight=this.container.clientHeight-a+f;this.scrollWidth=this.container.scrollWidth-b;this.scrollHeight=this.container.scrollHeight-a;this.element=this.$C("div",{"class":"touchscrollelement",style:";overflow:hidden;width:"+this.scrollWidth+"px;padding:"+parseInt(f/2)+"px "+parseInt(d/2)+"px;position:absolute;top:-"+this.container.scrollTop+"px;left:-"+this.container.scrollLeft+"px;"});this.wrapper=this.$C("div",{"class":"touchscrollwrapper",style:";overflow:hidden;position:relative;width:100%;height:"+this.clientHeight+"px;"});while(this.container.childNodes.length){this.element.appendChild(this.container.firstChild)}this.wrapper.appendChild(this.element);var c=";opacity:0;filter:alpha(opacity=0);position:absolute;overflow:hidden;-webkit-transition:opacity 400ms ease-out;-moz-transition:opacity 400ms ease-out;-o-transition:opacity 400ms ease-out;-ms-transition:opacity 400ms ease-out;transition:opacity 400ms ease-out;",e=";position:absolute;width:100%;height:100%;top:0;left:0;background-color:"+this.cfg.color+";-webkit-border-radius:"+this.cfg.width+"px;-moz-border-radius:"+this.cfg.width+"px;border-radius:"+this.cfg.width+"px;";this.horizontalBar=this.$C("div",{"class":"touchscrollhorizontal",style:c});this.verticalBar=this.$C("div",{"class":"touchscrollvertical",style:c});this.horizontalScrollBar=this.$C("div",{"class":"touchscrollbar horizontal",style:e});this.verticalScrollBar=this.$C("div",{"class":"touchscrollbar vertical",style:e});this.horizontalBar.appendChild(this.horizontalScrollBar);this.verticalBar.appendChild(this.verticalScrollBar);this.wrapper.appendChild(this.horizontalBar);this.wrapper.appendChild(this.verticalBar);this.css(this.horizontalBar,{display:this.scrollWidth>this.clientWidth?"block":"none",width:this.clientWidth+"px",left:0,bottom:0,height:this.cfg.width+"px"});this.css(this.verticalBar,{display:this.scrollHeight>this.clientHeight?"block":"none",height:this.clientHeight+"px",right:0,top:0,width:this.cfg.width+"px"});this.container.appendChild(this.wrapper);this.scrollHeight=Math.max(this.scrollHeight,this.element.clientHeight);this.scrollWidth=Math.max(this.scrollWidth,this.element.clientWidth);this.refresh(0);this.refresh(1);this.addListener(this.wrapper,this.startEvent,this.bind(this.start,this),false)},refresh:function(j,l){j=!!parseInt(j)*1;var k,c,d,h,e,i,a,f,b,g;f=this[this.property[j][6]];k=this[this.property[j][4]];c=this[this.property[j][3]];d=Math.max(this.cfg.width,this.cfg.minLength);b=parseInt(this.css(this.element,this.property[j][0]));g=k==c?0:parseInt(b/(k-c)*1000)/1000;h=Math.max(parseInt(c*c/k),d);if(b>0){e=Math.max(this.cfg.width,h-b/c*h);i=0;a="auto"}else{if(b<=c-k){e=Math.max(this.cfg.width,(k+b)/c*h);i="auto";a=0}else{e=h;i=-b/((k-c)||1)*(c-e)+"px";a="auto"}}f.style[this.property[j][2]]=e+"px";f.style[this.property[j][0]]=i;f.style[this.property[j][1]]=a;this["ratio"+j]=g;if(l){this.css(this[this.property[j][5]],{opacity:this.cfg.opacity});this.css(this[this.property[1-j][5]],{opacity:0})}this.cfg.onscroll.call(this,null)},toggleShow:function(c){c=c||window.event;if(this.wrapper&&(this.fixedMouse(c,this.container)||this.supportsTouches)){var b=c.type,a=0;switch(b){case this.overEvent:a=this.cfg.opacity;this.mouseEnter=true;break;case this.outEvent:this.mouseEnter=false;break;default:return false}if(!this.during){this.css(this.horizontalBar,{opacity:a});this.css(this.verticalBar,{opacity:a})}}},_scroll:function(i,a){var f,c=40,h,e,b,g,d,j,a;b=0;f=parseInt(this.css(this.element,this.property[i][0]));e=this[this.property[i][4]]-this[this.property[i][3]];h=f+a;if(h>0){if(h>c){a=c-f;b=-c}else{b=-h}}else{if(h<-e){if(h<-e-c){a=-e-c-f;b=c}else{b=-e-h}}}g=400*Math.abs(a)/(Math.abs(a)+Math.abs(b));j=function(){this.slide(i,b,400-g,"ease-in-out")};this.slide(i,a,g,d,j)},scroll:function(b,a){for(var c=0;c<arguments.length;c++){this._scroll(c,arguments[c])}},scrollTo:function(a,b){this.css(this.element,{left:-a+"px",top:-b+"px"});this.refresh(0);this.refresh(1)},slide:function(i,a,k,e,l){var h=this,n=l||new Function(),j=parseInt(this.css(this.element,this.property[i][0])),c=a,g=0,f=k||400,m=e||"ease-out";function b(p,o,u,s,r){var q;switch(r){case"ease-in-out":if((p/=s/2)<1){q=u/2*p*p*p+o}else{q=u/2*((p-=2)*p*p+2)+o}break;default:q=-u*((p=p/s-1)*p*p*p-1)+o;break}return q}function d(){if(a&&g<f){g+=10;h.element.style[h.property[i][0]]=b(g,j,c,f,m)+"px";h.timer[i]=setTimeout(d,10);h.refresh(i,true)}else{h.during=false;h.element.style[h.property[i][0]]=j+a+"px";if(!h.mouseEnter&&!l){h.css(h.horizontalBar,{opacity:0});h.css(h.verticalBar,{opacity:0})}h.refresh(i);n.call(h,null)}h.deleteAll("timer"+i)}this.during=true;clearTimeout(this.timer[i]);d()},start:function(b){clearTimeout(this.timer[0]);clearTimeout(this.timer[1]);if(!this.supportsTouches){this.preventDefault(b)}this.element.onclick=null;var a=b&&b.target||window.event.srcElement;if(a.nodeType==3){a=a.parentNode}this.target=a==this.wrapper||a==this.element||this.contains(this.element,a)?0:1;this.startPos=this.getPoint(b);this.elementRect=[parseInt(this.css(this.element,"left")),parseInt(this.css(this.element,"top"))];this.disc=[[new Date()],[this.startPos]]},move:function(f){if(!this.disc||f.touches&&f.touches.length>1||f.scale&&f.scale!==1){return}this.endPos=this.getPoint(f);var c=[this.endPos.x-this.startPos.x,this.endPos.y-this.startPos.y],g,b,d=1;if(typeof this.flag=="undefined"){if(this.scrollWidth>this.clientWidth&&Math.abs(c[0])>=Math.abs(c[1])){this.flag=0}else{if(this.scrollHeight>this.clientHeight&&Math.abs(c[1])>=Math.abs(c[0])){this.flag=1}else{this.flag=false}}}if(this.flag===false){return}this.preventDefault(f);this.during=true;b=this[this.property[this.flag][4]]-this[this.property[this.flag][3]];if(this.target){var a=parseInt(this.css(this[this.property[this.flag][6]],this.property[this.flag][2]));d=-b/(this[this.property[this.flag][3]]-a)}g=this.elementRect[this.flag]+c[this.flag]*d;if(g>0){g=g/(g/this[this.property[this.flag][3]]+1)}else{if(g<-b){g=g+b;g=g/(Math.abs(g)/this[this.property[this.flag][3]]+1)-b}}this.element.style[this.property[this.flag][0]]=g+"px";this.refresh(this.flag,true);this.disc[0].push(new Date());this.disc[1].push(this.endPos)},end:function(f){if(!this.disc){return}if(typeof this.flag==="number"){var i,h,b,c,g,d,a;i=0;a=this[this.property[this.flag][4]]-this[this.property[this.flag][3]];h=parseInt(this.css(this.element,this.property[this.flag][0]));if(h>0){i=-h}else{if(h<-a){i=-a-h}else{if(!this.target){b=new Date();while(this.disc[0].length&&b-this.disc[0][0]>200){this.disc[0].shift();this.disc[1].shift()}if(this.disc[0].length){d=b-this.disc[0][0];c=[this.endPos.x-this.disc[1][0].x,this.endPos.y-this.disc[1][0].y];g=c[this.flag];if(Math.abs(g)>20){i=(2-d/200)*g}}}}}if(this.cfg.ondrag.call(this,this.flag,i)!==false){this._scroll(this.flag,i)}this.element.onclick=new Function("return false;")}this.deleteAll("startPos","endPos","disc","flag","target","elementRect")},mouseScroll:function(d){this.preventDefault(d);d=d||window.event;var c=d.wheelDelta||d.detail&&d.detail*-1||0,b=120,f=this.cfg.mouseAlign,a;if(this.wrapper&&c){a=c/Math.abs(c);this._scroll(f,a*b)}}};window.TouchScroll=TouchScroll;
